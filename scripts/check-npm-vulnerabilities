#!/bin/bash

CSV_URL="https://raw.githubusercontent.com/DataDog/indicators-of-compromise/main/shai-hulud-2.0/shai-hulud-2.0.csv"
CSV_FILE="/tmp/shai-hulud-2.0.csv"

echo "Downloading vulnerability list..."
curl -s "$CSV_URL" -o "$CSV_FILE"

if [ ! -f "$CSV_FILE" ]; then
    echo "Error: unable to download CSV file"
    exit 1
fi

if [ ! -f "package.json" ] && [ ! -f "package-lock.json" ] && [ ! -d "node_modules" ]; then
    echo "No npm files found in current directory"
    exit 1
fi

FOUND_MALICIOUS=()

while IFS=',' read -r package_name package_version; do
    if [ "$package_name" != "package_name" ] && [ -n "$package_name" ]; then
        if [ -f "package.json" ] && grep -q "\"$package_name\"" package.json 2>/dev/null; then
            FOUND_MALICIOUS+=("$package_name (package.json)")
        fi
        if [ -f "package-lock.json" ] && grep -q "\"$package_name\"" package-lock.json 2>/dev/null; then
            FOUND_MALICIOUS+=("$package_name (package-lock.json)")
        fi
        if [ -d "node_modules/$package_name" ]; then
            FOUND_MALICIOUS+=("$package_name (node_modules)")
        fi
    fi
done < "$CSV_FILE"

if [ ${#FOUND_MALICIOUS[@]} -gt 0 ]; then
    echo "VULNERABILITIES DETECTED:"
    for item in "${FOUND_MALICIOUS[@]}"; do
        echo "  - $item"
    done
    exit 1
else
    echo "No vulnerabilities found"
fi

rm -f "$CSV_FILE"
