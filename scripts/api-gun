#!/bin/bash

API_DIR="$HOME/dev/personal/dotfiles/example-api"

if [ ! -d "$API_DIR" ]; then
    echo "API directory not found: $API_DIR"
    exit 1
fi

REQUEST=""
ENV=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --env)
            ENV="$2"
            shift 2
            ;;
        *)
            if [ -z "$REQUEST" ]; then
                REQUEST="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$REQUEST" ]; then
    echo "Simple API Testing"
    echo ""
    echo "Usage:"
    echo "  api <request> --env <environment>"
    exit 0
fi

if [ -z "$ENV" ]; then
    echo "Environment required. Use --env <environment>"
    exit 1
fi

ENV_FILE="$API_DIR/environments/$ENV.env"

if [ ! -f "$ENV_FILE" ]; then
    echo "Environment not found: $ENV"
    exit 1
fi

if [ -d "$API_DIR/$REQUEST" ] && [ -f "$API_DIR/$REQUEST/run.sh" ]; then
    REQUEST_FILE="$API_DIR/$REQUEST/run.sh"
else
    echo "Request not found: $REQUEST"
    exit 1
fi

export $(cat "$ENV_FILE" | xargs)
bash "$REQUEST_FILE"
