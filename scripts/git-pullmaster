#!/usr/bin/env bash
set -euo pipefail

BLUE='\033[0;34m'
GREEN='\033[0;32m'
NO_COLOR='\033[0m'

MAX_DEPTH=2

repos=()

current_git_root=""
if git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    current_git_root=$(git rev-parse --show-toplevel)
    repos+=("$current_git_root")
fi

while IFS= read -r gitdir; do
    repo_dir=$(realpath "$(dirname "$gitdir")")
    [[ "$repo_dir" != "$current_git_root" ]] && repos+=("$repo_dir")
done < <(find . -maxdepth "$MAX_DEPTH" -type d -name ".git")

# Deduplicate
unique_repos=$(printf "%s\n" "${repos[@]}" | sort -u)

while IFS= read -r repo_dir; do
    cd "$repo_dir" || continue

    repo_name=$(basename "$repo_dir")
    branch_name=$(git rev-parse --abbrev-ref HEAD)

    echo -e "Pulling in ${BLUE}${repo_name}${NO_COLOR} on branch ${GREEN}${branch_name}${NO_COLOR}"
    git pull || echo -e "\033[0;31mFailed to pull ${repo_name}\033[0m"

    cd - > /dev/null || exit 1
done <<< "$unique_repos"
