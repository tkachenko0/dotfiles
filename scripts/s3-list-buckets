#!/usr/bin/env bash

set -euo pipefail

TMPFILE=$(mktemp)
PRESIGNED=false

for arg in "$@"; do
  if [ "$arg" == "--presigned-url" ]; then
    PRESIGNED=true
  fi
done

select_bucket() {
  echo "Fetching buckets..."
  aws s3 ls | awk '{print $3}' | fzf --prompt="ðŸª£ Select a bucket: "
}

BUCKET=""
for arg in "$@"; do
  if [[ "$arg" != "--presigned-url" ]]; then
    BUCKET="$arg"
  fi
done

if [ -z "$BUCKET" ]; then
  BUCKET=$(select_bucket)
  if [ -z "$BUCKET" ]; then
    echo "No bucket selected."
    exit 1
  fi
fi

aws s3 ls "s3://$BUCKET" --recursive | awk '{print $4}' > "$TMPFILE"

if [ ! -s "$TMPFILE" ]; then
  echo "No files found in bucket '$BUCKET'"
  rm "$TMPFILE"
  exit 1
fi

SELECTED=$(cat "$TMPFILE" | fzf --height 40% --reverse)

rm "$TMPFILE"

if [ -z "$SELECTED" ]; then
  echo "No file selected."
  exit 1
fi

if [ "$PRESIGNED" = true ]; then
  URL=$(aws s3 presign "s3://$BUCKET/$SELECTED")
  echo "$URL"
  exit 0
fi

TMPJSON=$(mktemp)
aws s3 cp "s3://$BUCKET/$SELECTED" "$TMPJSON" >/dev/null

if jq empty "$TMPJSON" >/dev/null 2>&1; then
  cat "$TMPJSON" | jq
else
  echo "File is not JSON, skipping display."
fi

rm "$TMPJSON"
